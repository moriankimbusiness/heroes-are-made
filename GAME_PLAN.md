# GAME PLAN (업데이트: 2026-02-28 v45)

---

# 게임 컨셉

- 핵심 문장: **용사는 태어나는 것이 아니라 만들어진다.**
- 장르 결합: 타워 디펜스 + 로그라이크 + 덱빌딩.
- 플레이어는 최대 4명의 히어로 모험단을 운영해 마왕 토벌 원정을 진행한다.
- 원정은 선형 스토리라인(챕터 순차 진행)으로 구성한다.
- 히어로 획득 방식은 `모험가 뽑기`가 아니라 원정 진행 중 선택/육성 기반으로 설계한다.

---

# 원정/스토리 구조

- 모험단 최대 인원은 **4명**이다.
- 챕터는 순서대로 진행되는 선형 구조를 기본으로 한다.
- 챕터 클리어 시 다음 챕터로 이동하며, 최종 목표는 마왕 처치다.
- 선형 구조의 단조로움은 웨이브 변이/카드 선택/유물 조합으로 보완한다.

---

# 게임 진행 플로우

- 진행 단위는 `챕터 단위 런`이다.
- 기본 흐름은 `메인화면` -> `챕터 시작 준비` -> `게임월드(경로 선택)` -> `노드 해소(전투/비전투)` -> `게임월드 복귀`다.
- `전투 플레이화면`은 현재 구현 진행 중이며, 본 섹션은 전투 외 진행 규칙을 우선 확정한다.

## 런 단위 / 실패 처리

- 챕터 시작 시 해당 챕터 전용 런 상태를 생성한다.
- 전투 패배 시 해당 챕터 런은 즉시 종료한다.
- 코어 생존 승리라도 전투 종료 시 모든 히어로가 전투 불능이면 런을 즉시 종료한다.
- 실패한 노드 재도전은 허용하지 않는다.
- 메타 진행(영구 성장/영구 해금)은 이번 범위에서 제외한다.

## 상태 전이 (전투 외 중심)

- `메인화면` -> `챕터 시작 준비 화면` -> `게임월드(경로 선택)` -> `노드 전용 화면` -> `노드 결과 요약` -> `게임월드(경로 선택)` 순환.
- 전투 노드 승리 시 `전투 보상 선택` -> `노드 결과 요약` -> `게임월드(경로 선택)` 순서로 복귀한다.
- `챕터 최종보스 클리어` -> `챕터 결과 화면` -> `다음 챕터 시작 준비` 또는 `런 성공 결과 화면`.
- `전투 패배` -> `런 실패 결과 화면` -> `메인화면` 또는 `새 런 시작`.

## 시스템 설정(Options)

- 메인화면에는 `설정` 진입 버튼을 제공한다.
- 설정 화면은 `해상도`, `전체화면`, `배경음`, `효과음` 항목을 제공한다.
- 해상도는 프리셋(`1280x720`, `1600x900`, `1920x1080`) 기반으로 선택한다.
- 설정 변경은 즉시 런타임에 반영하고 자동 저장한다.
- 설정 저장 경로는 `user://settings.cfg`를 사용한다.
- BGM/SFX 오디오 소스가 아직 없어도 버스 볼륨/음소거 설정은 선반영한다.

## 챕터 시작 준비 화면

- 허용 기능은 `편성` + `장비관리`로 제한한다.
- 상점/강화/회복 서비스는 준비 화면에서 제공하지 않는다.
- 준비 완료 시 `출정`으로 월드맵을 생성하고 진입한다.

## 게임월드 생성 규칙 (사다리형 분기)

- 시작 노드와 최종 노드는 각각 1개 고정한다.
- 시작과 최종 사이 깊이 구간은 스텝별로 노드 수 `1~3` 랜덤을 사용한다.
- 플레이어는 현재 위치와 연결된 다음 노드 중 1개만 선택한다.
- 월드맵 정보(노드 타입/연결)는 챕터 시작 시 전체 공개한다.

### 깊이(Depth) 고정 규칙

- `D0`: 시작 노드 1개.
- `D1~D6`: 각 깊이 노드 수 1~3개 랜덤.
- `D7`: 최종보스 노드 1개.

### 노드 타입 배치 규칙

- `D4`(4스텝 층)에는 중간보스 노드를 정확히 1개 배치한다.
- `D7`은 최종보스 노드로 고정한다.
- 마을 노드는 `D2~D5` 사이에서 챕터당 최소 1회 보장한다.
- 동일 깊이에서 노드가 3개일 때, 동일 타입 3중복은 금지한다.

### 경로 연결 규칙

- 각 노드는 다음 깊이의 인접 인덱스(`-1`, `0`, `+1`)를 우선 연결 후보로 사용한다.
- 모든 노드는 최소 1개 진입 경로와 최소 1개 진출 경로를 보장한다.
- 고립 노드(연결 없는 노드)는 생성하지 않는다.

## 월드 노드 타입

- 일반 전투 노드: 일반 적 웨이브 전투.
- 중간보스 노드: 강화된 적/패턴 전투.
- 최종보스 노드: 챕터 클리어 조건 전투.
- 아이템 획득 노드: 장비/카드/유물 보상 선택.
- 마을 노드: 아이템 강화/정비/회복/상점.
- 이벤트 노드(`?`): 랜덤 선택지/리스크-보상 이벤트.

## 노드 전용 화면 규칙

- 전투 계열 노드(일반/중간보스/최종보스)는 전투 플레이화면으로 전환한다.
- 전투 승리 후에는 전용 보상 선택 화면에서 3개 중 1개를 확정한다.
- 아이템 획득 노드는 보상 `3개 제시, 1개 선택`을 기본 규칙으로 사용한다.
- 마을 노드는 `회복`, `강화`, `상점`, `정비완료` UI 흐름으로 처리한다.
- 이벤트 노드는 선택지 처리 후 결과를 확정한다.
- 모든 노드는 해소 후 `노드 결과 요약`을 거쳐 월드맵으로 복귀한다.

## 전투 진입/복귀 결과 반영 이벤트 계약

- `run_started(run_id, chapter_id)`
- `world_node_selected(node_id, node_type)`
- `battle_started(node_id, encounter_id)`
- `battle_finished(node_id, victory, summary)`
- `world_node_resolved(node_id, result)`
- `chapter_cleared(chapter_id)`
- `run_failed(reason, chapter_id, node_id)`
- `run_cleared(run_id)`

## 월드/런 데이터 모델 계약

- `RunState`: `run_id`, `chapter_index`, `gold`, `party_state`, `core_state`, `inventory_state`, `relics`, `seed`
- `PartyState`: `selected_count`, `max_count`, `heroes[]`
- `HeroRunSnapshot`: `hero_display_name`, `class_id`, `level`, `current_exp`, `required_exp`, `max_health`, `current_health`, `is_dead`
- `CoreState`: `max_health`, `current_health`
- `ChapterState`: `chapter_id`, `world_graph`, `current_node_id`, `visited_nodes`, `is_chapter_cleared`
- `WorldNodeData`: `node_id`, `depth`, `node_type`, `position`, `reward_profile`, `flags`
- `WorldEdgeData`: `from_node_id`, `to_node_id`
- `NodeResolutionResult`: `node_id`, `result_type`, `hp_delta`, `gold_delta`, `granted_rewards`, `consumed_resources`, `next_state`

## 저장/복구 최소 스펙

- 노드 선택 확정 직후 `ChapterState`를 저장한다.
- 노드 보상 선택 확정 직후 `RunState`를 저장한다.
- 선택 미확정 상태(보상 화면 이탈 등)는 저장 반영하지 않는다.

## 이번 범위 제외 (Out of Scope)

- 메타 진행(영구 성장/영구 해금) 시스템.
- 챕터별 상세 수치 밸런스(적 체력/보상 수치 테이블).
- 전투 플레이화면 내부 로직 세부 재설계.

## 구현 반영 (v18, 진행 플로우 2차)

- 실행 진입 씬은 `scenes/flow/game_flow.tscn`이며, 루트는 화면 오케스트레이션만 담당한다.
- 화면 씬을 8개로 분리했다.
- `main_menu_screen`, `chapter_prep_screen`, `world_map_screen`, `node_resolve_screen`, `battle_reward_screen`, `node_result_screen`, `run_result_screen`, `battle_screen_host`.
- `scripts/flow/GameFlowController.gd`는 화면 전환/런 상태/저장 라우팅만 담당한다.
- `NodeResolveScreen.gd`가 아이템/마을/이벤트 노드 처리 로직을 담당하고 `node_resolved` 결과를 컨트롤러에 전달한다.
- 전투 상태(`영웅 체력/레벨/사망`, `코어 HP`, `전투 골드`)는 `battle_finished.summary`를 통해 런 상태로 반영한다.
- 상태 전이는 `메인화면` -> `챕터 시작 준비` -> `게임월드(경로 선택)` -> `노드 전용 화면` -> (`전투 노드`: 보상 선택) -> `노드 결과 요약` -> `게임월드`로 유지한다.
- 월드맵 생성은 `scripts/flow/WorldMapGenerator.gd`에서 처리한다.
- 규칙 반영: `D0=1`, `D1~D6=1~3 랜덤`, `D4 중간보스 1개`, `D7 최종보스 1개`, `D2~D5 마을 최소 1개`.
- 월드맵 UI는 `WorldMapScreen` 내부 `WorldMapView`로 노드/연결을 시각화하고, 연결된 다음 노드만 선택 가능하게 제한한다.
- `BattleOverlayPanel`은 제거했고, 전투 중 상태 라벨을 별도 오버레이로 유지하지 않는다.
- 저장 포맷은 `save_version=3` 기반 `user://run_state_v3.json`을 사용한다.
- 노드 선택 확정 시 저장, 노드 해소 확정 시 저장.
- 전투 노드는 기존 `scenes/levels/level_01.tscn`을 재사용한다.
- `RoundManager.all_rounds_cleared`, 코어 `destroyed`, `Hero.died` 기반 전멸 판정(`BattleSummaryCollector.are_all_heroes_dead`)은 `BattleScreenHost`를 통해 `battle_finished`/`run_failed` 흐름으로 연결한다.
- `EnemySpawnController`가 스폰한 적 노드는 레벨 루트(전투 인스턴스 하위)에 귀속해 전투 종료(`BattleScreenHost.hide_screen`) 시 함께 해제되도록 유지한다.
- 기존 `alive_enemy_threshold` 기반 패배는 제거하고, 전투 패배는 `코어 파괴` 또는 `영웅 전멸`로 고정한다.
- 설정 시스템은 `scripts/core/AppSettings.gd` 오토로드로 관리하고, `MainMenuScreen -> SettingsScreen` 진입/복귀 흐름을 추가했다.

---

# 전장 / 코어(수레)

- 모험단의 수레를 **코어**로 사용한다.
- 코어(수레)는 전투 레벨 기준 맵 중앙에 배치한다.
- 코어는 공통 재사용 가능한 별도 씬(`scenes/core/core_base.tscn`)으로 관리한다.
- 코어는 전용 스크립트(`scripts/core/Core.gd`)로 개별 체력(HP)과 `apply_damage` API를 가진다.
- 코어 월드 오브젝트 상단에는 체력바+수치(`HealthBar`, `HealthText`)를 항상 표시한다.
- 코어 체력 UI는 `Core.health_changed` 시그널 기반으로만 갱신한다.
- 코어 충돌 범위는 `RectangleShape2D`(사각형)로 유지하며, 기본 크기는 `96x96`(32px 타일 기준 3x3)로 고정한다.
- 코어 시각 표시(`CoreVisual`) 범위는 충돌 사각형 크기와 동일하게 유지한다.
- 히어로 이동 가능 타일에서 코어 3x3 점유 타일은 제외한다.
- 전투의 최우선 보호 대상은 코어(수레)다.
- 기존 `적 통과 횟수 기반 패배`는 폐기한다.
- 패배 조건은 아래 중 하나로 정의한다.
- 코어 내구도(HP)가 0이 된다.
- 모든 히어로가 전투 불능(Down) 상태가 된다.

---

# 라운드 UI / 게임 속도

- 화면 상단 중앙 라운드 타이머 우측에 게임 속도 제어 UI를 둔다.
- 제공 버튼: `일시정지`, `1x`, `2x`
- 속도 배율 규칙:
- `일시정지` = `0x` (`Engine.time_scale = 0.0`)
- `1x` = `Engine.time_scale = 1.0`
- `2x` = `Engine.time_scale = 2.0`
- 기본 시작 배속은 항상 `1x`다.
- 속도 변경은 UI 버튼 이벤트 기반으로 처리한다 (`_process` 기반 폴링 없음).

## 카메라

- 전투 카메라는 수동 이동/줌을 지원한다.
- 이동 입력: `W`, `A`, `S`, `D`
- 확대/축소 입력: 마우스 휠
- 휠 방향 기준: `휠 업 = 확대`, `휠 다운 = 축소`
- 카메라 최소 줌 배율은 `0.75`로 유지한다.
- 확대(zoom in)는 `Camera2D.zoom` 값 감소(< 1.0)로 정의한다.
- `일시정지(0x)` 상태에서도 카메라 이동/줌 입력은 허용한다(게임플레이 로직 정지는 유지).
- 카메라는 전투 화면 경계 사각형 내부에서만 이동한다(줌 배율을 반영한 화면 전체 기준으로 경계 클램프 적용).
- 고배율(zoom 값 증가) 구간으로 화면 전체 경계 유지가 불가능한 경우, 카메라 중심을 경계 중앙에 고정해 뷰포트 이탈을 방지한다.
- 현재 단계에서는 맵 확장(기존 화면보다 넓은 필드)은 보류하고 카메라 기본 동작부터 적용한다.

---

# 히어로

## 기본 규칙

- 최대 히어로 보유 수는 **4명**이다.
- `모험가 뽑기` 시스템은 사용하지 않는다.
- 각 히어로는 **종족(Race) + 클래스(Class)** 조합을 가진다.
- 종족과 클래스는 이후 확장 가능하도록 데이터 기반 설계한다.
- 각 히어로는 개별 체력(HP)을 가진다.
- 히어로 HP가 0이 되면 Down 상태가 되며 타깃/공격/스킬 수행에서 제외된다.
- 구현 반영: 선택 히어로 상태창에 `체력: 현재/최대`를 이벤트 기반(`health_changed`)으로 표시한다.
- 구현 반영: 히어로 피격 시 `hurt` 애니메이션 대신 빨간 윤곽선 + 내부 반투명 빨간 플래시를 짧게 재생한다(`apply_damage` 이벤트 트리거).
- 구현 반영: 히어로 사망 시 `death` 애니메이션을 재생하고(`play_death`), 전투 로직은 중단하되 오브젝트는 씬에 남긴다(자동 `queue_free` 없음).
- 구현 반영: 히어로 애니메이션 데이터는 에디터 authoring 기준으로 관리한다(`hurt` 제거, `death` 유지, autoplay=`idle`).
- 구현 반영: 히어로 월드 오브젝트 상단에 체력바(`HealthBar`)를 표시하고 `health_changed` 시그널 기반으로 갱신한다.

## 전투 히어로 인터페이스 (v31)

- 히어로 좌클릭 선택 시 화면 하단 약 1/4 영역에 전용 `HeroInterface`를 표시한다.
- 좌->우 고정 컬럼은 `초상화/장비/스탯/장비 카드/리롤` 순서를 사용한다.
- 초상화는 선택 히어로의 `AnimatedSprite2D`를 UI 스프라이트로 실시간 미러링한다(애니메이션/프레임/flip 동기화).
- 초상화 하단 정보 영역은 안내 문구 대신 히어로 체력바와 `현재/최대` 수치(예: `100/100`)를 표시한다.
- 선택된 히어로 월드 오브젝트에는 `초록 윤곽선 + 반투명 초록 채움`을 적용해 선택 상태를 명확히 구분한다.
- 히어로 이름은 `Hero.hero_display_name`을 우선 사용한다.
- 장비 슬롯은 3칸(`무기`, `방어구`, `신발`)만 사용한다.
- 아이템 타입/장착 슬롯도 3체계(`WEAPON`, `ARMOR`, `BOOTS`)로 단순화한다.
- 스탯 표시는 `총합(버프)` 형식을 사용한다. 예: `힘: 8(3▲)`.
- 버프가 0일 때는 괄호를 생략한다. 예: `힘: 8`, `사거리: 35.0`.
- 레벨 행은 `Level`, EXP 게이지, `현재/필요` 숫자를 함께 표시한다.
- 레벨/EXP는 이번 단계에서 전투 임시값으로 운영한다(런 저장 연동 제외).
- 사망한 히어로도 클릭 선택을 허용하며, 상태창 정보 열람이 가능하다.
- 히어로 공격 범위 표시는 수동 토글이 아니라 `HeroInterface > 사거리` 스탯 라벨 hover 상태를 기준으로 유지한다.
- 히어로 클릭 선택만으로는 공격 범위를 표시하지 않고, 선택된 히어로의 `사거리` 라벨 hover 중에만 표시한다.
- hover 종료 또는 선택 해제 시 공격 범위를 숨긴다.
- 우클릭 이동 명령 시 월드 좌표에 스타크래프트식 `타원형 + ▼` 이동 마커를 표시한다.
- 이동 마커는 최근 1개만 유지하고, 타원 링은 고정한 채 `▼` 화살표만 위아래 바운스한 뒤 짧은 시간 내 자동 페이드아웃한다.
- 장비 카드 상점은 타입별 3장(`무기`, `방어구`, `신발`)을 동시에 제공한다.
- 카드 호버 시 시각 스케일을 `1.3x`로 확대한다.
- 카드 리롤은 무료 5회 후 유료로 전환한다.
- 유료 리롤 비용은 `10, 20, 30...` 선형 증가하고, 전투(레벨) 재진입 시 초기화한다.
- 카드 구매/리롤은 버튼 이벤트 기반 처리로 유지한다(폴링 루프 추가 없음).

---

## 이동 및 범위

- 전투 맵은 `32x32` 타일맵(`GroundTiles`, `BlockedTiles`) 기반으로 구성한다.
- 전투 배경 렌더는 `level_base.tscn`의 공통 `BattleGroundTiles` 레이어를 사용한다.
- `BattleGroundTiles`는 공통 타일셋(`assets/tilesets/battle_tileset.tres`)을 공유하고, 레벨 변형 씬(`level_01`, `level_02` 등)에서 타일 배치만 다르게 편집한다.
- 전투 장식은 공통 레이어(`BattleShadowTiles`, `BattlePlantTiles`, `BattlePropsTiles`)에 분리해 편집한다.
- 공통 타일셋은 `Grass + Plant + Props + Shadow + Shadow Plant` 아틀라스 소스를 함께 제공한다.
- 전투 맵 데이터의 단일 소스는 `BattleMap` 씬으로 고정한다(`Ground/Blocked/Deco/RangeOverlay` 포함).
- `PlayGround`는 타일 데이터를 소유하지 않고, `BattleMap` API를 통해 경로/좌표/오버레이를 사용한다.
- `level_base`는 `BattleMapSlot`으로 맵 변형 씬을 주입받는 구조를 사용한다.
- `BattleScreenHost`는 전투 진입 시 맵 변형 배열에서 1개를 선택해 `BattleMapSlot`에 인스턴스한다(랜덤 인카운트 확장 준비).
- 맵 변형 기본 아트 규칙:
- `battle_map_01`: 중앙 3타일 폭 stone lane + 상/하 식생/바위/그림자 분포.
- `battle_map_02`: 완만한 굴곡 stone lane + 맵01과 다른 식생/바위 분포.
- 장식 충돌 규칙은 `바위/큰 나무만 차단`을 기본으로 유지한다.
- 이동 가능 영역은 `GroundTiles` 기준이며, `BlockedTiles`와 코어 3x3 점유 타일은 이동 불가로 처리한다.
- 조작은 `좌클릭 선택 + 우클릭 이동 명령`을 사용한다.
- 우클릭 이동 명령은 현재 선택된 히어로 1명에게만 적용한다.
- 이동 명령이 활성화된 동안 히어로는 `walk` 애니메이션 상태를 유지한다.
- 이동 명령이 활성화된 동안 자동공격은 보류하고, 이동 종료 시 자동공격 로직으로 복귀한다.
- 우클릭 목표는 클릭한 타일의 중심 좌표로 스냅한다.
- 히어로 이동 경로는 타일 A*(`AStarGrid2D`)로 계산하고, 실제 이동은 경로점을 따라 연속 이동한다.
- 바닥 레이어는 오브젝트 하단 렌더를 위해 `GroundTiles.z_index=-100`, `BlockedTiles.z_index=-90`으로 고정한다.
- 이동 적용 순서는 아래를 따른다.
- 1) 우클릭 월드 좌표를 타일 좌표로 변환
- 2) 타깃 타일 이동 가능 여부(`GroundTiles`/`BlockedTiles`/코어 점유) 검사
- 3) A* 타일 경로 계산
- 4) 타일 중심 경로점 기준 `move_speed` 스텝 이동 후 도착 시 idle 복귀
- 기본 도착 허용 오차는 1px를 사용한다(`move_stop_distance=1.0`).
- 경로 데이터가 유효하지 않으면 히어로는 즉시 정지하고 현재 위치를 유지한다.

### 이동 판정 규칙

- 현재 경로탐색 우회 대상은 타일 기반 정적 장애물(`BlockedTiles`, 코어 3x3 점유)로 제한한다.
- 동적 장애물(적/다른 히어로) 회피는 이번 단계 범위에서 제외한다.
- 이동 경로 계산/스텝 적용은 이동 명령 활성 시에만 `_physics_process`에서 수행한다.

### 범위(사거리) 규칙

- 히어로 선택 시 `HeroInterface`를 표시하고, 실제 공격 사거리 타일 사각형(`NxN`)은 `사거리` 라벨 hover 중에만 표시한다.
- 클래스별 기본 타일 범위:
- 전사 `4x4`, 궁수 `5x5`, 마법사 `5x5`, 암살자 `3x3`
- 중심 타일 정렬을 위해 짝수 범위는 내부 판정에서 홀수로 보정한다(예: 전사 `4x4` -> `5x5`).
- 공격 대상 판정은 충돌 Area 오버랩이 아니라 타일 좌표 포함 여부로 처리한다.
- 사거리 중심 타일은 히어로 점유 타일이 바뀔 때만 갱신한다(픽셀 단위 연속 이동 중 사거리 미끄럼 없음).
- 타깃 부재 상태에서는 `AttackTimer` 기반 주기 재탐색으로 자동공격 시작을 복구한다.
- 사거리 표시는 타일 텍스처 오버레이가 아닌 전용 드로우 노드(`RangeOverlayDraw`)에서 셀 단위로 직접 렌더한다.
- 사거리 오버레이는 `무채색 반투명 채움 + 흰색 격자/윤곽선`으로 표시한다.
- 격자/윤곽선은 픽셀아트 기준 `1px` 두께, 안티앨리어싱 없이 렌더한다.
- 히어로가 점유한 중심 타일은 사거리 채움에서 제외한다.
- 오버레이는 `GroundTiles` 바로 위(`z_index=-110`, 그라운드와 동일 레벨)에서 렌더하고, 장식/오브젝트 레이어보다 아래에 둔다.
- 오버레이 갱신은 선택 토글 및 히어로 점유 타일 변경 이벤트에서만 수행한다.
- 오버레이 셀 렌더 범위는 `GroundTiles` 존재 여부가 아니라 전장 타일 경계(rect) 기준으로 처리해 `5x5` 내부가 비지 않게 유지한다.

---

## 편성/합류

- 최초 시작은 히어로 3명으로 고정한다.
- 런 시작 전 모험단 편성 단계에서 히어로를 확정한다 (최대 4명).
- 런 진행 중 신규 히어로 합류는 월드 이벤트/보상 노드 기반으로만 발생한다.
- 전투 중 실시간 소환 버튼(`모험가 뽑기`)은 두지 않는다.

---

# 적 AI / 타깃팅

- 적의 기본 이동 목표는 코어(수레)다.
- 적 이동은 `NavigationAgent2D` 기반 경로를 우선 사용하고, 경로가 유효하지 않으면 코어 직선 추적으로 폴백한다.
- 레벨 씬의 `Path2D`/`PathFollow2D` 템플릿은 제거하고, 적은 포탈 월드 좌표에 직접 스폰한다.
- 히어로가 `HeroDetectArea`에 진입하면 적은 코어보다 히어로 추적을 우선한다.
- 다중 히어로 감지 시 최근접 히어로를 추적 대상으로 선택한다.
- 추적 중 목표가 `AttackRange`에 들어오면 즉시 공격 상태로 전환하고, `attack` 애니메이션을 액션 트리거마다 재시작한다.
- 공격 주기(`attacks_per_second`)마다 대상 히어로에게 피해를 적용한다.
- 추적 대상이 감지 범위 이탈/Down/사망 처리되면 코어 타깃으로 복귀한다.
- 특수 적은 예외 타깃 규칙을 가질 수 있으나 기본 규칙을 우선 적용한다.
- 구현 반영: `Enemy/HeroDetectArea` 충돌 마스크를 히어로 레이어(`8`)로 설정해 감지 기반 우선 공격을 활성화한다.
- 적 감지 범위와 공격 범위는 독립값으로 운영한다 (`HeroDetectArea` vs `AttackRange`).
- 범위 값/계산식 소유는 `Enemy` 루트가 아니라 각 담당 노드(`HeroDetectArea`, `AttackRange`)에서 관리한다.
- 적 공격 범위 계산식: `final_attack_range = max(1.0, (base_attack_range + attack_range_add) * attack_range_scale)`
- 적 감지 범위 계산식: `final_detect_range = max(1.0, (base_detect_range + detect_range_add) * detect_range_scale)`
- 적 클릭 시 공격 범위 원만 화면에 표시한다.
- 히어로 공격 가능 대상이 없고 코어 충돌 사각형이 공격 범위 원 안에 들어오면, 적은 코어를 공격한다.
- 코어 공격 판정은 `AttackRange` 원 중심과 코어 사각형 최근접점 거리 기반으로 계산한다.

---

# 전투 시스템 개편안 (v4, 적용 우선순위)

## 1) 코어 방어 구조 강화

- 코어는 내구도 기반으로 생존한다.
- 코어 주변 방어 구간(가드 링/균열 포인트)을 두어 적 압박 방향을 읽고 배치 의사결정을 만든다.
- 목적: 기존 "통과 카운트"보다 명확한 방어 목표와 긴장감 확보.

## 2) 히어로 역할 전환 카드

- 히어로를 고정 딜러가 아닌 전투 중 태세 전환 유닛으로 운영한다.
- 예: `집중 사격(단일)`, `제압 사격(광역)`, `호위 태세(코어 근처 적 우선)`.
- 목적: 같은 조합에서도 덱 선택에 따라 전투 운영이 달라지게 한다.

## 3) 카드 타입 이원화

- 카드 타입을 `즉시 효과`와 `전장 규칙 변경`으로 분리한다.
- 즉시 효과 예: 순간 회복, 즉시 피해, 즉시 배치 재정렬.
- 전장 규칙 변경 예: `8초 감속 지대`, `특정 구간 봉쇄`, `적 경로 우회`.
- 목적: 단순 스탯 버프 일변도를 피하고 전술 개입감을 높인다.

## 4) 웨이브 변이(로그라이크 조건)

- 매 웨이브 시작 시 적 변이 옵션을 1개 이상 부여한다.
- 예: 원거리 저항, 사망 시 분열, 코어 대상 추가 피해.
- 플레이어는 웨이브 종료 보상 카드/유물로 카운터 빌드를 만든다.
- 목적: 매 판 문제풀이를 다르게 만들어 리플레이성을 확보한다.

## 5) 보상 이원화

- 보상 축을 `골드`와 `카드/유물`로 분리한다.
- 골드: 장비 구매/강화/회복/마을 서비스 담당.
- 카드/유물: 전투 규칙 변경과 시너지 빌드 담당.
- 목적: 경제 성장과 전술 성장의 선택 충돌을 만들어 덱빌딩 재미를 강화한다.

---

# 종족 시스템 (Race)

## 개념

- 종족은 **기본 성장 성향 + 고유 패시브**를 가진다.
- 레벨업 시 종족 성장 테이블이 자동 적용된다.

## 예시 1차 종족

### 인간
- 성장: 힘+1, 민첩+1, 지능+1, 사거리+0.1
- 패시브: 카드 선택 시 추가 옵션 등장 확률 증가

### 엘프
- 성장: 힘+0, 민첩+1, 지능+1, 사거리+0.3
- 패시브: 사거리 내 적 수에 비례해 공격력 증가

### 드워프
- 성장: 힘+2, 민첩+0, 지능+0, 사거리+0
- 패시브: 보스 대상 추가 피해

### 악마
- 성장: 힘+0, 민첩+0, 지능+2, 사거리+0
- 패시브: 적 처치 시 공격력 스택 증가

---

# 클래스 시스템 (Class)

## 개념

- 클래스는 **전투 역할 및 공격 타입**을 정의한다.
- 레벨업 시 클래스 성장 테이블이 자동 적용된다.

## 예시 1차 클래스

### 전사
- 성장: 힘+2
- 기본 공격: 단일 물리 공격

### 궁수
- 성장: 민첩+2
- 기본 공격: 장거리 단일 공격

### 마법사
- 성장: 지능+2
- 기본 공격: 범위 마법 공격

### 암살자
- 성장: 힘+1, 민첩+2
- 기본 공격: 근접 단일 + 치명타 특화

---

# 레벨 시스템

## 기본 규칙

- 히어로가 몬스터를 처치할 때마다 몬스터 데이터의 EXP를 획득한다.
- 최대 레벨은 30이다.
- 레벨별 필요 EXP는 별도 테이블(`level_exp_table`)로 관리한다.

---

## 레벨업 스탯 증가 방식

- 플레이어 수동 스탯 분배는 제거한다.
- 레벨업 시 스탯은 자동 증가한다.
- 레벨업 시 최종 증가량은 `종족 성장 + 클래스 성장 + 유물/버프 보정`으로 계산한다.

### 공식

- 레벨업 판정: `current_exp >= level_exp_table[current_level]`
- 스탯 증가: `delta_stat = race_growth[level] + class_growth[level] + bonus_growth[level]`
