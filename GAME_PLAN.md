# GAME PLAN (업데이트: 2026-02-27 v18)

---

# 게임 컨셉

- 핵심 문장: **용사는 태어나는 것이 아니라 만들어진다.**
- 장르 결합: 타워 디펜스 + 로그라이크 + 덱빌딩.
- 플레이어는 최대 4명의 히어로 모험단을 운영해 마왕 토벌 원정을 진행한다.
- 원정은 선형 스토리라인(챕터 순차 진행)으로 구성한다.
- 히어로 획득 방식은 `모험가 뽑기`가 아니라 원정 진행 중 선택/육성 기반으로 설계한다.

---

# 원정/스토리 구조

- 모험단 최대 인원은 **4명**이다.
- 챕터는 순서대로 진행되는 선형 구조를 기본으로 한다.
- 챕터 클리어 시 다음 챕터로 이동하며, 최종 목표는 마왕 처치다.
- 선형 구조의 단조로움은 웨이브 변이/카드 선택/유물 조합으로 보완한다.

---

# 게임 진행 플로우

- 진행 단위는 `챕터 단위 런`이다.
- 기본 흐름은 `메인화면` -> `챕터 시작 준비` -> `게임월드(경로 선택)` -> `노드 해소(전투/비전투)` -> `게임월드 복귀`다.
- `전투 플레이화면`은 현재 구현 진행 중이며, 본 섹션은 전투 외 진행 규칙을 우선 확정한다.

## 런 단위 / 실패 처리

- 챕터 시작 시 해당 챕터 전용 런 상태를 생성한다.
- 전투 패배 시 해당 챕터 런은 즉시 종료한다.
- 실패한 노드 재도전은 허용하지 않는다.
- 메타 진행(영구 성장/영구 해금)은 이번 범위에서 제외한다.

## 상태 전이 (전투 외 중심)

- `메인화면` -> `챕터 시작 준비 화면` -> `게임월드(경로 선택)` -> `노드 전용 화면` -> `노드 결과 요약` -> `게임월드(경로 선택)` 순환.
- `챕터 최종보스 클리어` -> `챕터 결과 화면` -> `다음 챕터 시작 준비` 또는 `런 성공 결과 화면`.
- `전투 패배` -> `런 실패 결과 화면` -> `메인화면` 또는 `새 런 시작`.

## 챕터 시작 준비 화면

- 허용 기능은 `편성` + `장비관리`로 제한한다.
- 상점/강화/회복 서비스는 준비 화면에서 제공하지 않는다.
- 준비 완료 시 `출정`으로 월드맵을 생성하고 진입한다.

## 게임월드 생성 규칙 (사다리형 분기)

- 시작 노드와 최종 노드는 각각 1개 고정한다.
- 시작과 최종 사이 깊이 구간은 스텝별로 노드 수 `1~3` 랜덤을 사용한다.
- 플레이어는 현재 위치와 연결된 다음 노드 중 1개만 선택한다.
- 월드맵 정보(노드 타입/연결)는 챕터 시작 시 전체 공개한다.

### 깊이(Depth) 고정 규칙

- `D0`: 시작 노드 1개.
- `D1~D6`: 각 깊이 노드 수 1~3개 랜덤.
- `D7`: 최종보스 노드 1개.

### 노드 타입 배치 규칙

- `D4`(4스텝 층)에는 중간보스 노드를 정확히 1개 배치한다.
- `D7`은 최종보스 노드로 고정한다.
- 마을 노드는 `D2~D5` 사이에서 챕터당 최소 1회 보장한다.
- 동일 깊이에서 노드가 3개일 때, 동일 타입 3중복은 금지한다.

### 경로 연결 규칙

- 각 노드는 다음 깊이의 인접 인덱스(`-1`, `0`, `+1`)를 우선 연결 후보로 사용한다.
- 모든 노드는 최소 1개 진입 경로와 최소 1개 진출 경로를 보장한다.
- 고립 노드(연결 없는 노드)는 생성하지 않는다.

## 월드 노드 타입

- 일반 전투 노드: 일반 적 웨이브 전투.
- 중간보스 노드: 강화된 적/패턴 전투.
- 최종보스 노드: 챕터 클리어 조건 전투.
- 아이템 획득 노드: 장비/카드/유물 보상 선택.
- 마을 노드: 아이템 강화/정비/회복/상점.
- 이벤트 노드(`?`): 랜덤 선택지/리스크-보상 이벤트.

## 노드 전용 화면 규칙

- 전투 계열 노드(일반/중간보스/최종보스)는 전투 플레이화면으로 전환한다.
- 아이템 획득 노드는 보상 `3개 제시, 1개 선택`을 기본 규칙으로 사용한다.
- 마을 노드는 `회복`, `강화`, `상점`, `정비완료` UI 흐름으로 처리한다.
- 이벤트 노드는 선택지 처리 후 결과를 확정한다.
- 모든 노드는 해소 후 `노드 결과 요약`을 거쳐 월드맵으로 복귀한다.

## 전투 진입/복귀 결과 반영 이벤트 계약

- `run_started(run_id, chapter_id)`
- `world_node_selected(node_id, node_type)`
- `battle_started(node_id, encounter_id)`
- `battle_finished(node_id, victory, summary)`
- `world_node_resolved(node_id, result)`
- `chapter_cleared(chapter_id)`
- `run_failed(reason, chapter_id, node_id)`
- `run_cleared(run_id)`

## 월드/런 데이터 모델 계약

- `RunState`: `run_id`, `chapter_index`, `gold`, `party_state`, `inventory_state`, `relics`, `seed`
- `ChapterState`: `chapter_id`, `world_graph`, `current_node_id`, `visited_nodes`, `is_chapter_cleared`
- `WorldNodeData`: `node_id`, `depth`, `node_type`, `position`, `reward_profile`, `flags`
- `WorldEdgeData`: `from_node_id`, `to_node_id`
- `NodeResolutionResult`: `node_id`, `result_type`, `hp_delta`, `gold_delta`, `granted_rewards`, `consumed_resources`, `next_state`

## 저장/복구 최소 스펙

- 노드 선택 확정 직후 `ChapterState`를 저장한다.
- 노드 보상 선택 확정 직후 `RunState`를 저장한다.
- 선택 미확정 상태(보상 화면 이탈 등)는 저장 반영하지 않는다.

## 이번 범위 제외 (Out of Scope)

- 메타 진행(영구 성장/영구 해금) 시스템.
- 챕터별 상세 수치 밸런스(적 체력/보상 수치 테이블).
- 전투 플레이화면 내부 로직 세부 재설계.

## 구현 반영 (v18, 진행 플로우 2차)

- 실행 진입 씬은 `scenes/flow/game_flow.tscn`이며, 루트는 화면 오케스트레이션만 담당한다.
- 화면 씬을 7개로 분리했다.
- `main_menu_screen`, `chapter_prep_screen`, `world_map_screen`, `node_resolve_screen`, `node_result_screen`, `run_result_screen`, `battle_screen_host`.
- `scripts/flow/GameFlowController.gd`는 화면 전환/런 상태/저장 라우팅만 담당한다.
- `NodeResolveScreen.gd`가 아이템/마을/이벤트 노드 처리 로직을 담당하고 `node_resolved` 결과를 컨트롤러에 전달한다.
- 상태 전이는 `메인화면` -> `챕터 시작 준비` -> `게임월드(경로 선택)` -> `노드 전용 화면` -> `노드 결과 요약` -> `게임월드`로 유지한다.
- 월드맵 생성은 `scripts/flow/WorldMapGenerator.gd`에서 처리한다.
- 규칙 반영: `D0=1`, `D1~D6=1~3 랜덤`, `D4 중간보스 1개`, `D7 최종보스 1개`, `D2~D5 마을 최소 1개`.
- 월드맵 UI는 `WorldMapScreen` 내부 `WorldMapView`로 노드/연결을 시각화하고, 연결된 다음 노드만 선택 가능하게 제한한다.
- `BattleOverlayPanel`은 제거했고, 전투 중 상태 라벨을 별도 오버레이로 유지하지 않는다.
- 저장 포맷은 `save_version=2` 기반 `user://run_state_v2.json`으로 전환했다 (v1 마이그레이션 미지원).
- 노드 선택 확정 시 저장, 노드 해소 확정 시 저장.
- 전투 노드는 기존 `scenes/levels/level_01.tscn`을 재사용한다.
- `RoundManager`(`all_rounds_cleared`, `game_failed`)와 코어 `destroyed` 신호는 `BattleScreenHost`를 통해 `battle_finished`/`run_failed` 흐름으로 연결한다.

---

# 전장 / 코어(수레)

- 모험단의 수레를 **코어**로 사용한다.
- 코어(수레)는 전투 레벨 기준 맵 중앙에 배치한다.
- 코어는 공통 재사용 가능한 별도 씬(`scenes/core/core_base.tscn`)으로 관리한다.
- 코어는 전용 스크립트(`scripts/core/Core.gd`)로 개별 체력(HP)과 `apply_damage` API를 가진다.
- 코어 충돌 범위는 `RectangleShape2D`(사각형)로 유지한다.
- 코어 시각 표시(`CoreVisual`) 범위는 충돌 사각형 크기와 동일하게 유지한다.
- 히어로/적 이동 보정은 코어 충돌 범위 내부 진입을 허용하지 않는다.
- 전투의 최우선 보호 대상은 코어(수레)다.
- 기존 `적 통과 횟수 기반 패배`는 폐기한다.
- 패배 조건은 아래 중 하나로 정의한다.
- 코어 내구도(HP)가 0이 된다.
- 모든 히어로가 전투 불능(Down) 상태가 된다.

---

# 라운드 UI / 게임 속도

- 화면 상단 중앙 라운드 타이머 우측에 게임 속도 제어 UI를 둔다.
- 제공 버튼: `일시정지`, `1x`, `2x`
- 속도 배율 규칙:
- `일시정지` = `0x` (`Engine.time_scale = 0.0`)
- `1x` = `Engine.time_scale = 1.0`
- `2x` = `Engine.time_scale = 2.0`
- 기본 시작 배속은 항상 `1x`다.
- 속도 변경은 UI 버튼 이벤트 기반으로 처리한다 (`_process` 기반 폴링 없음).

## 카메라

- 전투 카메라는 수동 이동/줌을 지원한다.
- 이동 입력: `W`, `A`, `S`, `D`
- 확대/축소 입력: 마우스 휠
- 휠 방향 기준: `휠 업 = 축소`, `휠 다운 = 확대`
- 현재 단계에서는 맵 확장(기존 화면보다 넓은 필드)은 보류하고 카메라 기본 동작부터 적용한다.

---

# 히어로

## 기본 규칙

- 최대 히어로 보유 수는 **4명**이다.
- `모험가 뽑기` 시스템은 사용하지 않는다.
- 각 히어로는 **종족(Race) + 클래스(Class)** 조합을 가진다.
- 종족과 클래스는 이후 확장 가능하도록 데이터 기반 설계한다.
- 각 히어로는 개별 체력(HP)을 가진다.
- 히어로 HP가 0이 되면 Down 상태가 되며 타깃/공격/스킬 수행에서 제외된다.
- 구현 반영: 선택 히어로 상태창에 `체력: 현재/최대`를 이벤트 기반(`health_changed`)으로 표시한다.

---

## 이동 및 범위

- 방어 가능 영역의 기준점은 코어(수레) 중심으로 설정한다.
- 원형 플레이영역 기본 반경은 `220`으로 시작한다.
- 코어는 사각 충돌(`RectangleShape2D`)을 사용하며, 히어로 이동 가능 영역에서 제외한다.
- 드래그로 이동 목표 지점을 지정하며, 드래그 중 히어로 본체는 실시간 이동하지 않는다.
- 히어로 최종 위치 결정 순서는 아래를 따른다.
- 1) 플레이영역 원형 경계 클램프
- 2) 코어 사각 충돌 영역 바깥으로 푸시
- 3) 히어로-히어로 겹침 해소(캡슐 콜라이더 기준)
- 4) 목적지 충돌 판정(적/히어로 겹침 금지)
- 5) 경로 스윕 판정(적/히어로 경로 차단 시 이동 불가)
- 드래그 드롭(마우스 버튼 해제) 시점에만 최종 좌표를 1회 적용한다.

### 이동 판정 로드맵

- 현재 구현(Phase 2-2):
- 원형 플레이영역 + 코어 사각 충돌 + 히어로 간 겹침 해소를 이벤트/계산 기반으로 처리한다.
- 레이캐스트는 이동 차단에 사용하지 않고 관통(시각 프리뷰 용도)으로 처리한다.
- 이동 가능 판정은 `목적지 충돌(적/히어로/코어)` + `경로 스윕 충돌(적/히어로)`으로 결정한다.
- 최종 목표점이 가능해도 경로 스윕에서 적/히어로에 막히면 이동 불가로 처리한다.
- 코어 진입 불가는 별도 충돌 보정(`clamp_to_play_area`)으로 강제한다.
- 다음 단계(Phase 2-3):
- 차단 사유(`enemy_path`, `hero_path`, `destination_overlap`)별 프리뷰 피드백 세분화를 추가한다.

### 이동 목표 미리보기 규칙

- 드래그 중 이동 예정 위치에는 원형 마커만 표시한다.
- 미리보기는 상태 색상으로 유효성을 표시한다.
- 유효(이동 가능): 초록색
- 무효(이동 불가): 빨간색
- 드래그 종료 시점 최종 적용 좌표는 미리보기 기준과 동일해야 한다.

### 범위(사거리) 규칙

- 히어로 선택 시 실제 공격 사거리 원형을 표시한다.
- 히어로 공격 사거리 계산식:
- `final_attack_range = max(1.0, (base_attack_range + attack_range_add) * attack_range_scale)`
- 사거리 갱신 트리거:
- `_ready` 초기화 시 1회
- 장비 변경/스탯 재계산 후 즉시
- 향후 버프/디버프 시스템 연결 시 상태 변경 이벤트 기반으로 갱신

---

## 편성/합류

- 최초 시작은 히어로 3명으로 고정한다.
- 런 시작 전 모험단 편성 단계에서 히어로를 확정한다 (최대 4명).
- 런 진행 중 신규 히어로 합류는 월드 이벤트/보상 노드 기반으로만 발생한다.
- 전투 중 실시간 소환 버튼(`모험가 뽑기`)은 두지 않는다.

---

# 적 AI / 타깃팅

- 적의 기본 이동 목표는 코어(수레)다.
- 적 이동은 `NavigationAgent2D` 기반 경로를 우선 사용하고, 경로가 유효하지 않으면 코어 직선 추적으로 폴백한다.
- 이동 경로/근접 범위에 히어로가 존재하면 히어로를 우선 공격한다.
- 히어로 감지 범위 진입 시 적은 공격 상태로 전환하고, `attack` 애니메이션을 액션 트리거마다 재시작한다.
- 공격 주기(`attacks_per_second`)마다 대상 히어로에게 피해를 적용한다.
- 우선 타깃 히어로가 Down/사망 처리되면 코어 타깃으로 복귀한다.
- 특수 적은 예외 타깃 규칙을 가질 수 있으나 기본 규칙을 우선 적용한다.
- 구현 반영: `Enemy/HeroDetectArea` 충돌 마스크를 히어로 레이어(`8`)로 설정해 감지 기반 우선 공격을 활성화한다.
- 적 감지 범위와 공격 범위는 독립값으로 운영한다 (`HeroDetectArea` vs `AttackRange`).
- 범위 값/계산식 소유는 `Enemy` 루트가 아니라 각 담당 노드(`HeroDetectArea`, `AttackRange`)에서 관리한다.
- 적 공격 범위 계산식: `final_attack_range = max(1.0, (base_attack_range + attack_range_add) * attack_range_scale)`
- 적 감지 범위 계산식: `final_detect_range = max(1.0, (base_detect_range + detect_range_add) * detect_range_scale)`
- 적 클릭 시 공격 범위 원만 화면에 표시한다.
- 히어로 공격 가능 대상이 없고 코어 충돌 사각형이 공격 범위 원 안에 들어오면, 적은 코어를 공격한다.
- 코어 공격 판정은 `AttackRange` 원 중심과 코어 사각형 최근접점 거리 기반으로 계산한다.

---

# 전투 시스템 개편안 (v4, 적용 우선순위)

## 1) 코어 방어 구조 강화

- 코어는 내구도 기반으로 생존한다.
- 코어 주변 방어 구간(가드 링/균열 포인트)을 두어 적 압박 방향을 읽고 배치 의사결정을 만든다.
- 목적: 기존 "통과 카운트"보다 명확한 방어 목표와 긴장감 확보.

## 2) 히어로 역할 전환 카드

- 히어로를 고정 딜러가 아닌 전투 중 태세 전환 유닛으로 운영한다.
- 예: `집중 사격(단일)`, `제압 사격(광역)`, `호위 태세(코어 근처 적 우선)`.
- 목적: 같은 조합에서도 덱 선택에 따라 전투 운영이 달라지게 한다.

## 3) 카드 타입 이원화

- 카드 타입을 `즉시 효과`와 `전장 규칙 변경`으로 분리한다.
- 즉시 효과 예: 순간 회복, 즉시 피해, 즉시 배치 재정렬.
- 전장 규칙 변경 예: `8초 감속 지대`, `특정 구간 봉쇄`, `적 경로 우회`.
- 목적: 단순 스탯 버프 일변도를 피하고 전술 개입감을 높인다.

## 4) 웨이브 변이(로그라이크 조건)

- 매 웨이브 시작 시 적 변이 옵션을 1개 이상 부여한다.
- 예: 원거리 저항, 사망 시 분열, 코어 대상 추가 피해.
- 플레이어는 웨이브 종료 보상 카드/유물로 카운터 빌드를 만든다.
- 목적: 매 판 문제풀이를 다르게 만들어 리플레이성을 확보한다.

## 5) 보상 이원화

- 보상 축을 `골드`와 `카드/유물`로 분리한다.
- 골드: 장비 구매/강화/회복/마을 서비스 담당.
- 카드/유물: 전투 규칙 변경과 시너지 빌드 담당.
- 목적: 경제 성장과 전술 성장의 선택 충돌을 만들어 덱빌딩 재미를 강화한다.

---

# 종족 시스템 (Race)

## 개념

- 종족은 **기본 성장 성향 + 고유 패시브**를 가진다.
- 레벨업 시 종족 성장 테이블이 자동 적용된다.

## 예시 1차 종족

### 인간
- 성장: 힘+1, 민첩+1, 지능+1, 사거리+0.1
- 패시브: 카드 선택 시 추가 옵션 등장 확률 증가

### 엘프
- 성장: 힘+0, 민첩+1, 지능+1, 사거리+0.3
- 패시브: 사거리 내 적 수에 비례해 공격력 증가

### 드워프
- 성장: 힘+2, 민첩+0, 지능+0, 사거리+0
- 패시브: 보스 대상 추가 피해

### 악마
- 성장: 힘+0, 민첩+0, 지능+2, 사거리+0
- 패시브: 적 처치 시 공격력 스택 증가

---

# 클래스 시스템 (Class)

## 개념

- 클래스는 **전투 역할 및 공격 타입**을 정의한다.
- 레벨업 시 클래스 성장 테이블이 자동 적용된다.

## 예시 1차 클래스

### 전사
- 성장: 힘+2
- 기본 공격: 단일 물리 공격

### 궁수
- 성장: 민첩+2
- 기본 공격: 장거리 단일 공격

### 마법사
- 성장: 지능+2
- 기본 공격: 범위 마법 공격

### 암살자
- 성장: 힘+1, 민첩+2
- 기본 공격: 근접 단일 + 치명타 특화

---

# 레벨 시스템

## 기본 규칙

- 히어로가 몬스터를 처치할 때마다 몬스터 데이터의 EXP를 획득한다.
- 최대 레벨은 30이다.
- 레벨별 필요 EXP는 별도 테이블(`level_exp_table`)로 관리한다.

---

## 레벨업 스탯 증가 방식

- 플레이어 수동 스탯 분배는 제거한다.
- 레벨업 시 스탯은 자동 증가한다.
- 레벨업 시 최종 증가량은 `종족 성장 + 클래스 성장 + 유물/버프 보정`으로 계산한다.

### 공식

- 레벨업 판정: `current_exp >= level_exp_table[current_level]`
- 스탯 증가: `delta_stat = race_growth[level] + class_growth[level] + bonus_growth[level]`
